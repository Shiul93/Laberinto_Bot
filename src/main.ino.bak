#include "arduino.h"
#include "main.h"
#include "pinout.h"
#include "motors.h"
#include "encoders.h"
//#include "profiler.h"
#include "speedController.h"
//#include "tone.h"
//#include "oled.h"
#include "elapsedMillis.h"
#include "IntervalTimer.h"
#include "TB6612.h"

unsigned long sysTickCounts = 0;
elapsedMicros systickMicros;

IntervalTimer sysTimer;
unsigned int sysTickMilisPeriod = 100;
unsigned int sysTickSecond = 1000/sysTickMilisPeriod;

bool activateController = false;

void sysTick() {
//DEBUG1ON;
//DEBUG1OFF;
  systickMicros =0;
  //readSensors();
  updateEncoderData();
  if(activateController)
  {
    PIDcontroller();
    motorSpeedUpdate(RSpeedOUT,LSpeedOUT);
    //serialDebug();
  }
  else
  {
    //showData();
  }
  sysTickCounts++;
  //DEBUG1ON
  //showData();
  //DEBUG1OFF;
  //DEBUG1OFF;
}

void setup() {
  Serial.begin(9600);
  //setupPins();
  //setupSensors();
  analogWriteResolution(16);         // analogWrite value 0 to 65535
  analogWriteFrequency(driver_PWMA, 732.4218); // Teensy 3.0 pin 4 also changes to 732.4218 kHz
  analogWriteFrequency(driver_PWMB, 732.4218);

  setupInterrupts();
  //tonePlay();
  //while ((readSensors() & 0b010) == 0){}
  delay(1000);
  sysTimer.begin(sysTick, sysTickMilisPeriod*100);
}


void loop() {
  /*
  if(sysTickCounts > 0)                 {RSpeedSet = 25; LSpeedSet = 25;}
  if(sysTickCounts > 1*sysTickSecond)   {RSpeedSet = 40; LSpeedSet = 40;}
  if(sysTickCounts > 2*sysTickSecond)   {RSpeedSet = 25; LSpeedSet = 25;}
  if(sysTickCounts > 3*sysTickSecond)   {RSpeedSet = 0; LSpeedSet = 0;}
  if(sysTickCounts > 4*sysTickSecond)   {RSpeedSet = 70; LSpeedSet = 70;}
  //if(sysTickCounts > (4*sysTickSecond)) {sysTimer.end();}
  */
  if(sysTickCounts>= 10)
  {
    //serialDebug();
    checkBattery();
    Serial.printf("Enc L: %i, Enc R: %i, Distance %i, Angle %i \n",encoderL,encoderR,readDistance(),readAngle());

    //serialDebug();
    sysTickCounts = 0;
  }

}
